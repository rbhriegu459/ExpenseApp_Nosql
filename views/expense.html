<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Page</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navBar">
        <!-- <a href="/">Logout</a> -->
        <h4 id="premiumuser"></h4>
        <button class="rzp-button" id="premiumbutton">Buy Premium</button>
        <div id="message"></div>
    </nav>
    <div class="main">
        <div class="container">
            <form onsubmit="addNewExpense(event)">
                <label for="expenseamount">Expense Amount:</label>
                <input type="number" id="expenseamount" required>
        
                <label for="description">Description:</label>
                <input type="text" name="description" id="description">
        
                <label for="category">Category:</label>
                <select name="category" id="category">
                    <option value="fuel">Fuel</option>
                    <option value="shopping">Shopping</option>
                    <option value="stydyMaterial">Study material</option>
                    <option value="food">Food</option>
                    <option value="electricity">Electricity</option>
                </select>
                <button class="submitBtn">Add Expense</button>
            </form>
        </div>

        <div class="listOfExpense">
            <h2>List of Expenses</h2>
            <ol id="listOfExpenses"></ol>
        </div>
        <ul id="leaderboard" style="visibility: hidden;"></ul>
    
    </div>

    <!-- Axios Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.1/axios.min.js"></script>

    <!-- Razorpay Library -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>

        function showPremium(){
            document.getElementById('premiumbutton').style.visibility = "hidden";
            document.getElementById('premiumuser').innerHTML = "You are premium user now!";
        }

        window.addEventListener('DOMContentLoaded',()=>{
            const token = localStorage.getItem('token');
            const decodedToken = parseJwt(token);
            console.log(decodedToken);
            const ispremiumuser = decodedToken.ispremiumuser;
            if(ispremiumuser){
                showPremium();
                leaderBoardShow();
            }
            axios.get('http://localhost:3000/expense/loadExpense', {headers: {"Authorization":token}})
            .then(response => {
                console.log(response.data);
                response.data.expenses.forEach(expense => {
                    addNewExpenseToUi(expense);
                })
            })
            .catch(err => {
                console.log(err);
            })
        });

        async function addNewExpense(e){
            try{
                e.preventDefault();
                const expenseDetails = {
                    expenseamount: e.target.expenseamount.value,
                    description: e.target.description.value,
                    category: e.target.category.value
                }

                // console.log(expenseDetails);
                const token = localStorage.getItem('token');
                // console.log(token.value);
                const response = await axios.post("http://localhost:3000/expense/addExpense",expenseDetails, {headers: {"Authorization":token}}  );

                if(response.status === 201){
                    addNewExpenseToUi(response.data.expenses);
                } else{
                    throw new Error("Failed to create new Expense");
                }   
            }
            catch(err){
                document.body.innerHTML += `<div style="color:red;">Failed Adding New expense ${err.message}</div>`
            }
        }

        function addNewExpenseToUi(expenses){
            const parentElement = document.getElementById('listOfExpenses');
            const expenseElemId= `expense-${expenses.id}`;
            parentElement.innerHTML += `
                <li id=${expenseElemId} class="listItems">
                    ${expenses.expenseamount} - ${expenses.category} - ${expenses.description}
                    <button onclick='deleteExpense(event, ${expenses.id})' class="delBtn">
                        Delete Expense
                    </button>
                </li>
            `
        }

        async function deleteExpense(e, id){
            try {
                await axios.delete(`http://localhost:3000/expense/deleteExpense/${id}`)
                removeFromUI(id);
            }
            catch(err)  {
                console.log(err);
            }
        }

        function removeFromUI(id){
            const expenseElemId = `expense-${id}`;
            document.getElementById(expenseElemId).remove();
        }


        //>>>>>>>>>>>> Decoding jwt token >>>>>>>>>>>>>>
        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }


        // async function rzpAction(e){
        document.getElementById('premiumbutton').onclick = async function(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const response = await axios.get("http://localhost:3000/purchase/permiummembership", {headers: {"Authorization":token}});
            var options = {
                "key": 'rzp_test_cdBK53MEGt8dAR',
                "order_id": response.data.order.id,
                "handler": async function (response){

                    try{
                        const res = await axios.post("http://localhost:3000/purchase/updatetransactionstatus",{
                            orderid:response.razorpay_order_id,
                            payment_id: response.razorpay_payment_id
                        }, {headers: {"Authorization":token}});
                    
                        alert("You are a Premium User Now!!");
                        showPremium();
                        leaderBoardShow();
                        localStorage.setItem('token', res.data.token);
                    } catch(err) {
                        console.log(err);
                    }   

                },
            };
            const rzp1 = new Razorpay(options);
            rzp1.open();
            rzp1.on('payment failed', function (response){
                console.log(response);
                alert("Something went wrong!")
            })
        }

        function leaderBoardShow(){
            const inputElement = document.createElement("input");
            inputElement.type = "button";
            inputElement.value= "Show LeaderBoard";
            inputElement.id = "leaderBoardBtn"
            inputElement.onclick = async() =>{
                
                const token = localStorage.getItem('token');
                document.getElementById('leaderboard').style.visibility = "visible";
                document.getElementById("leaderBoardBtn").style.visibility = "hidden";
                
                const userLeaderBoardArray = await axios.get("http://localhost:3000/premium/showLeaderboard", {headers: {"Authorization": token} });

                var leaderboardElem = document.getElementById('leaderboard');
                leaderboardElem.innerHTML += '<h1>Leader Board </h1>'
                userLeaderBoardArray.data.forEach((userDetails) => {
                    leaderboardElem.innerHTML += `<li>Name - ${userDetails.name}, Total Expense - ${userDetails.total_expenses}`;
                })
            }
            document.getElementById("message").appendChild(inputElement);
        }
    </script>
</body>
</html>